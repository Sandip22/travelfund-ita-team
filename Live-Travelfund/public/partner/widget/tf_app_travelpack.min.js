/**
 * TravelFund Widget for OTAs.
 * @author asavaliya-itaction.
 */
var tf_ita_path = 'https://www.travelfund.co.uk/';
var tf_ita_img_path = 'https://www.travelfund.co.uk/';
var wrapper_padding = 18;
// Get query string
var tf_ita_script = document.getElementsByTagName('script');
var tf_ita_index = tf_ita_script.length - 1;
var tf_ita_script = tf_ita_script[tf_ita_index];
var tf_ita_qstring = tf_ita_script.src.replace(/^[^\?]+\??/, '');
var tf_ita_qp = [];
var partner_url = document.URL;

if(partner_url.search('beta.travelpack.com/') !== -1){
	tf_ita_path = 'http://tf-test.travelfund.co.uk/';
	tf_ita_img_path = 'http://tf-test.travelfund.co.uk/';
}else if(partner_url.search('travelfund.localhost') !== -1){
	tf_ita_path = 'http://travelfund.localhost/';
	tf_ita_img_path = 'http://travelfund.localhost/';
	tf_ita_qp['partner_code']="Travel-Fund";
}else if(partner_url.search('tf-test.travelfund.co.uk') !== -1){
	tf_ita_path = 'http://tf-test.travelfund.co.uk/';
	tf_ita_img_path = 'http://tf-test.travelfund.co.uk/';
	tf_ita_qp['partner_code']="Travel-Fund";
}else if(partner_url.search('travelfund.co.uk') !== -1){
	tf_ita_qp['partner_code']="Travel-Fund";
}


function tf_ita_parse_query_string(queryString) {
	var params = [], queries, temp, i, l;
	// Split into key/value pairs
	queries = queryString.split(/&(?:amp;)?/gi);
	// Convert the array of strings into an object
	for ( i = 0, l = queries.length; i < l; i++) {
		temp = queries[i].split('=');
		params[temp[0]] = temp[1];
	}
	return params;
};
/**
 * Initiate travelfund.
 * @param string wc_id widget container id. 
 */
function travelfund(wc_id) {
	
	tf_ita_qp = tf_ita_parse_query_string(tf_ita_qstring);
		
	//Get widget container.
	var widget_container = document.getElementById(wc_id);
	var action = widget_container.getAttribute('data-action');
	var img = widget_container.getAttribute('data-image') ;
	
	if ( typeof widget_container != "undefined") {
		
		var widget_img = '<img src="' + tf_ita_img_path + 'partner/image/' + img + '.gif"/>';
		
		if(action == 'application'){
			//Bind click event.
			_travelfund_bind_event(widget_container, "click", function() {
				travelfund_box(wc_id,action,img);
			});
			//Css
			widget_container.style.padding = "0";
			widget_container.style.background = "none";
			widget_container.style.border = "none";
			widget_container.style.cursor = "pointer";
			widget_container.innerHTML = widget_img;
			//Successful
			return true;	
		}else if(action == 'checkout'){
			travelfund_box(wc_id,action,img);	
		}
	}
	//Do not find travelfund script tag.
	return false;
}

/**
 * Create TravelFund box.
 * 
 */
function travelfund_box(wc_id,action,image) {
		
	tf_ita_path = 'https://www.travelfund.co.uk/';
	tf_ita_img_path = 'https://www.travelfund.co.uk/';

	if(partner_url.search('beta.travelpack.com/') !== -1){
		tf_ita_path = 'http://tf-test.travelfund.co.uk/';
		tf_ita_img_path = 'http://tf-test.travelfund.co.uk/';
	}else if(partner_url.search('travelfund.localhost') !== -1){
		tf_ita_path = 'http://travelfund.localhost/';
		tf_ita_img_path = 'http://travelfund.localhost/';
		tf_ita_qp['partner_code']="Travel-Fund";
	}else if(partner_url.search('tf-test.travelfund.co.uk') !== -1){
		tf_ita_path = 'http://tf-test.travelfund.co.uk/';
		tf_ita_img_path = 'http://tf-test.travelfund.co.uk/';
		tf_ita_qp['partner_code']="Travel-Fund";
	}else if(partner_url.search('travelfund.co.uk') !== -1){
		tf_ita_qp['partner_code']="Travel-Fund";
	}
	
	tf_ita_qp['action'] = action;
	tf_ita_qp['image'] = image;
	tf_ita_qp['wc_id'] = wc_id;
	
	//Hide partner div on close.	
	if(tf_ita_qp['action'] == 'checkout'){
		var ele = document.getElementById(wc_id);
		ele.style.display="block";
	}

	
	//Create travelfund application path as per partner request.
	switch(tf_ita_qp['action']) {
		case 'application' :
			tf_ita_path += "application/introduction/"+tf_ita_qp['partner_code']+"?partner_url="+partner_url;
			break;
		case 'checkout' :
			tf_ita_path += "application/login/"+tf_ita_qp['partner_code']+"?partner_url="+partner_url;
			break;
	}
	
	if (tf_ita_qp['action'] == 'checkout') {
		travelfund_login(wc_id);
	} else {
		travelfund_application();
	}
}

/**
 * Display login page.
 */
function travelfund_login(wc_id) {
	var iframe, iframe_container;
	//Open in new window if mobile or ipad is there..
	if (screen.width < 600 || /iPad/i.test(navigator.userAgent)) {
		window.open(tf_ita_path);
	} else {
		//Browser
		if (_is_before_ie8()) {
			document.body.scroll = "NO";
		} else {
                        // changed on 3rd June - website sroll disappear when it load https://beta.travelpack.com/ check out page
			//document.body.style.overflow = "hidden"; 
		}
		//Get Iframe Container
		iframe_container = get_element('tf_ita_iframe_container');
		iframe_container.style.position = "relative";
		iframe_container.style.border = "1px solid #008CBA";
		iframe_container.style.paddingRight = "2px";
		
		iframe_container.width = "100%";
		iframe_container.style.top=0;
		iframe_container.style.left=0;
		
		//Get Iframe
		iframe = get_element('tf_ita_iframe');
		iframe.width = "100%";
		//iframe.width = iframe_container.width - (2 * wrapper_padding);
		//iframe.height = iframe_container.height - (2 * wrapper_padding);
		//Append iframe into container.
		iframe_container.appendChild(iframe);
		
		//Append container to widget container.
		var widget_container = document.getElementById(wc_id);
		widget_container.appendChild(iframe_container);
		//Display Iframe
		iframe_container.style.display = "block";
		
		// Bind the functions...
		document.getElementById('tf_ita_iframe_container').onmousedown = function () {
		    _drag_init(this);
		    return false;
		};
		
		
	}
}

/**
 * Display application page.
 */
function travelfund_application() {
	var lightbox, iframe, iframe_container;
	//Open in new window if mobile or ipad is there..
	if (screen.width < 600 || /iPad/i.test(navigator.userAgent)) {
		window.open(tf_ita_path);
	} else {
		//Browser
		if (_is_before_ie8()) {
			document.body.scroll = "NO";
		} else {
			document.body.style.overflow = "hidden";
		}
		//Get lighbox
		lightbox = get_element('tf_ita_lightbox');
		document.body.appendChild(lightbox);
		//Get Iframe Container
		iframe_container = get_element('tf_ita_iframe_container');
		iframe_container.style.position = "fixed";
		iframe_container.style.zIndex = "10000";
		_travelfund_bind_event(window, "resize", _travelfund_lightbox_frame_resize);
		document.body.appendChild(iframe_container);
		//Get Iframe
		iframe = get_element('tf_ita_iframe');
		
		//iframe.width = iframe_container.width - (2 * wrapper_padding);
		//iframe.height = iframe_container.height - (2 * wrapper_padding);
		
		iframe.width = 700 - (2 * wrapper_padding);
		iframe.height = 500 - (2 * wrapper_padding);
		
		//Append iframe into container.
		iframe_container.appendChild(iframe);
		lightbox.style.display = "";
		_travelfund_lightbox_frame_resize();
		//Display Iframe
		iframe.src = tf_ita_path;
		iframe_container.style.display = "block";
	}
}


/**
 * Toggle Content when close iframe window
 * show confirm msg to leave applicaion process
 * @author Nirav D.
 * @returns {boolen}
 */
function toggleContent() {
  
  /* get Id */
  var contentId = document.getElementById("tf_ita_iframe");
  var dropdowndeals = document.getElementById("dropdowndeals");
  
  contentId.style.display == "none" ? contentId.style.display = "block" : contentId.style.display = "none"; 
  
  /* Alter confirm msg */
  if(contentId.style.display == "none"){
    dropdowndeals.style.display = "block";
  }
  if(contentId.style.display == "block"){
    dropdowndeals.style.display = "none";
  }
  
}

/**
 * Take me out of applicaiont process
 * @author Nirav D.
 * @returns none
 */
function travelfund_final_close() {
    
    if (document.getElementById("tf_ita_iframe")) {
		var iframe = document.getElementById("tf_ita_iframe");
	}
	if (document.getElementById("tf_ita_iframe_container")) {
		var iframe_container = document.getElementById("tf_ita_iframe_container");
		iframe_container.style.display = "none";
		iframe_container.removeChild(iframe);
	}
	if (document.getElementById("tf_ita_lightbox")) {
		var lightbox = document.getElementById("tf_ita_lightbox");
		lightbox.style.display = "none";
	}
	if (_is_before_ie8()) {
		document.body.scroll = "YES";
	} else {
		document.body.style.overflow = "scroll";
	}
    //close confirm window - hide
    dropdowndeals.style.display = "none";
    
    //Hide partner div on close.	
	if(tf_ita_qp['action'] == 'checkout'){
		var ele = document.getElementById(tf_ita_qp['wc_id']);
		ele.style.display="none";
	}   
}

/**
 * Show - Hide confirm msg with toggle functioning
 * @author Nirav D.
 * @returns {none}
 */
function travelfund_close() {
    
    /* Run toggle effect*/
     //   toggleContent();
     
     travelfund_final_close();
     
    /* set string*/
        var str;
        var logo;
        
        str = '<div style="position: absolute; top: 10px; right: 10px;"><a onclick="toggleContent();" href="javascript: void(0);"><img src="'+tf_ita_img_path+'skin/common/icon/close.png"></a></div>';
        logo = '<div class="large-12 columns"><div style="float:right;margin-right: 5px;"><img src="'+tf_ita_img_path+'skin/common/images/logo.png"></div></div>';
     
    /* confirm div generate */
    document.getElementById('dropdowndeals').innerHTML = '<div id="main_container" style="height:269px;background-color:white; width:864px;display: block; border: medium none; padding-top: 34px; padding-bottom: 18px; position: fixed; z-index: 10000; left: 157px; top: 17px; background-image: url('+tf_ita_img_path+'skin/common/images/background.png;); background-color: rgb(245, 245, 245);">' + str + logo + '<div class="row" style="float:right;padding-top:63px;"><div class="large-12 columns"><div style="margin-top: 20px;text-align:center;" class="panel radius"><table><tr><td>Are you sure you want to stop your application?<br /></td></tr><tr><td><br /><div class="large-4 medium-4 columns"><a style="background-color: #008CBA; border: medium none;color: #FFFFFF; cursor: pointer;display: inline-block;margin: 0 0 1.25rem;padding: 1.0625rem 2rem 1rem;position: relative;text-align: center;text-decoration: none;transition: background-color 300ms ease-out 0s;font-family: "Helvetica Neue","Helvetica",Helvetica,Arial,sans-serif;font-size: 1rem;font-weight: normal !important;" href="javascript:travelfund_final_close();">Yes - Take me back</a></div></td></tr><tr><td><div class="large-4 medium-4 columns"><a style="background-color: #008CBA; border: medium none;color: #FFFFFF; cursor: pointer;display: inline-block;margin: 0 0 1.25rem;padding: 1.0625rem 2rem 1rem;position: relative;text-align: center;text-decoration: none;transition: background-color 300ms ease-out 0s;font-family: "Helvetica Neue","Helvetica",Helvetica,Arial,sans-serif;font-size: 1rem;font-weight: normal !important;" href="javascript:toggleContent();">No - I will continue the application with travelfund...</a></div></td></tr></table></div></div></div></div>';
}

/**
 * Get HTML element
 */
function get_element(id) {
	var ele;
	//Return element if exist.
	if (document.getElementById(id)) {
		return document.getElementById(id);
	}
	//Create element for light box;
	switch(id) {
		case 'tf_ita_lightbox' :
			ele = document.createElement("div");
			ele.id = "tf_ita_lightbox";
			ele.style.top = "0px";
			ele.style.left = "0px";
			ele.style.height = "100%";
			ele.style.width = "100%";
			ele.style.position = "fixed";
			ele.style.zIndex = "9999";
			ele.style.backgroundColor = "#333333";
			ele.style.filter = "progid:DXImageTransform.Microsoft.Alpha(Opacity=65)";
			ele.style.opacity = "0.65";
			ele.style.display = "none";
			break;
		case 'tf_ita_iframe_container' :
			ele = document.createElement("div");
			ele.id = "tf_ita_iframe_container";
			ele.style.display = "none";
			ele.style.border = "none";
			/* ele.style.borderRadius = "15px";*/
			ele.style.backgroundColor = "#f5f5f5";
			ele.style.backgroundImage = "url(" + tf_ita_img_path + "skin/common/images/background.png)";
			ele.style.paddingTop = (wrapper_padding + 6) + "px";
			ele.style.paddingBottom = wrapper_padding + "px";
			ele.innerHTML = '<div style="position: absolute; top: 0px; right: 10px;"><a href="javascript: void(0);" onclick="travelfund_close();"><img src="' + tf_ita_img_path + 'skin/common/icon/close.png" /></a></div><div id="dropdowndeals" style="display:none;"><div>';
			break;
		case 'tf_ita_iframe' :
			ele = document.createElement("iframe");
			ele.id = "tf_ita_iframe";
			ele.style.border = "none";
			ele.frameBorder = "0";
			ele.src = tf_ita_path;
			break;
	}
	return ele;
}

/**
 * Bind event to elemement.
 * @param Object ele
 * @param String ita_event
 * @param Object handler
 */
function _travelfund_bind_event(ele, ita_event, handler) {
	if (ele.addEventListener) {
		ele.addEventListener(ita_event, handler, false);
	} else if (ele.attachEvent) {
		ele.attachEvent("on" + ita_event, handler);
	}
}

function _travelfund_lightbox_frame_resize() {
	var lightbox = document.getElementById("tf_ita_lightbox");
	var iframe_container = document.getElementById("tf_ita_iframe_container");
	var off_height;
	var off_width = null;
	var B = 900;
	off_height = lightbox.offsetHeight;
	off_width = lightbox.offsetWidth;
	
	//iframe_container.width = Math.floor((off_width / 1.1));
	iframe_container.height = Math.floor((off_height / 1.1));
	//iframe_container.width = (iframe_container.width > B ? B : iframe_container.width);
	
	//Put container in center. 
	//Ticket 531. Temporary solution
	iframe_container.width = "740";
	
	iframe_container.style.left = Math.floor((off_width - iframe_container.width) / 2) + "px";
	iframe_container.style.top = Math.floor((off_height - iframe_container.height) / 2) + "px";
	
	iframe = document.getElementById("tf_ita_iframe");
	//iframe.width = iframe_container.width - (2 * wrapper_padding);
	//iframe.height = iframe_container.height - (2 * wrapper_padding);
	
	iframe.width = "740px";
	iframe.height="500px";
	
}

function _is_before_ie8() {
	var A = false;
	if (navigator.userAgent.match(/MSIE (\d+\.\d+)/)) {
		var B = new Number(RegExp.$1);
		A = B < 8;
	}
	return A;
}

/*Drag and Drop Div Code*/

var selected = null, // Object of the element to be moved
    x_pos = 0, y_pos = 0, // Stores x & y coordinates of the mouse pointer
    x_elem = 0, y_elem = 0; // Stores top, left values (edge) of the element

// Will be called when user starts dragging an element
function _drag_init(elem) {
    // Store the object of the element which needs to be moved
    selected = elem;
    x_elem = x_pos - selected.offsetLeft;
    y_elem = y_pos - selected.offsetTop;
}

// Will be called when user dragging an element
function _move_elem(e) {
    x_pos = document.all ? window.event.clientX : e.pageX;
    y_pos = document.all ? window.event.clientY : e.pageY;
    if (selected !== null) {
        selected.style.left = (x_pos - x_elem) + 'px';
        selected.style.top = (y_pos - y_elem) + 'px';
    }
}

// Destroy the object when we are done
function _destroy() {
    selected = null;
}

//document.onmousemove = _move_elem;
//document.onmouseup = _destroy;			